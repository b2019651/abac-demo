00:00:01  if you're doing permissions like this where you're checking a user's role then you are doing permissions wrong in this master class I'm going to be going over every single style permission system out there from something that's incredibly simple and will work for many applications all the way up to Enterprise level permission systems that many companies charge thousands of dollars for and then you could build something like a Google Drive clone with and I'm going to be doing all this by going over multiple different diagrams showing you exactly how all these different things interact and going through code demonstrations all the way through the simple to extreme level permission systems so that way you know

00:00:32  how to use any permission system for your exact application welcome back to web dev simplified my name is Kyle and my job is to simplify the web for you so you can start building your dream project sooner and the very first thing that we're going to dive into is why this role-based way of doing permissions is not ideal and how it can quickly snowball into a terrible piece of code and hard to maintain but before we do that I first want to mention a huge thank you to clerk clerk is actually the sponsor of this video they're a really great authentication company I use them in a lot of my different projects that

00:01:03  I've built and I'm going to show you how you can actually integrate all of these permission systems into clerk if you want to you don't have to use clerk to use these permission systems they're all going to be built outside of clerk but then I'm going to show you how to integrate them into clerk just to show you how it makes a lot of these things even easier to do so the very first thing like I mentioned I want to talk about why this role-based system is not ideal so really quickly I have some very basic code over here where I just have a comment on a page and if you're an admin user you have the ability to delete this comment really straightforward and if I change the role of my user up here to admin you can see on the right hand side the delete button shows up for this

00:01:35  comment that's relatively straightforward but what happens if I want to add in a new role for example a moderator Ro well a moderator should probably have the ability to delete comments too so now I need to add another check in here to see if the user role is equal to moderator and if that is true or if their role is admin then the delete button should show up so now it doesn't matter which of those two roles they have they can delete this but now I also probably want users to be able to delete their own comment so I'm going to come in here with another or check so I can say user. ID is equal to like the author

00:02:07  ID so we'll say author ID we'll just come up here const author ID is equal to one just imagine that's like the ID of the actual comment itself so now you can see that I have a user that created this comment but if I'm a different user that did not create the comment you can now see I cannot delete it and very quickly you can see how this easily spirals out of control because now I have multiple levels of if checks all joined together with or and ANS to make this really complicated giant query and now if I need to change any of the permissions for example I want to change what my moderator can do so that they can no

00:02:38  longer delete these things I need to come to every single place I added this if check and I need to change that so it's incredibly difficult to add and modify permissions and every single time you want to modify the permission of some user or role I need to go into my actual code and change it instead of going into like a configuration file or a specific permissions file so my permissions and all of the stuff related to them is kind of littered throughout my entire code base so the very first permission system that we can move to to move away from this Ro based system is actually called Ro based access control rbac and it may sound like everything's

00:03:10  related to roles but instead we're switching over to a permission based mindset so here I have a really quick authentication file that's actually going to do all of these different permission handlings for us so for example here you can see I just have an object with all of my roles and all the different permissions they have and generally in these permission based systems what you're going to do is you're going to break down each thing that someone can do into two parts it's going to be the action for example view create update delete and then it's going to be the resource the thing that you're acting on for example like comments to-do products blogs articles whatever

00:03:41  are the things in your database that you want to act on that's going to be your resource and then the action is going to be the thing you want to do on that particular object generally when you're writing these systems you'll separate them by a colon this is a pretty standard practice so as you can see here all of the different permissions that my admin moderator and user can have are all defined in this one particular location now if you wanted you could move these into a database or store them wherever you want I'll even show you in my diagrams how you would store some of these inside of a database but for our particular use cases to keep everything as simple as possible I'm just going to

00:04:12  be storing everything directly in the code now the reason this is so much nicer is because it takes all of these complicated if checks to see what a user can do and what they can't do based on their role and it confines it all to this one configuration object and now I can just call this function called has permission all it does is it takes in a user and it takes in a permission for example view comments create comments update comments whatever it is that I want to do and it's going to check that permission on the user's role to see if it has that particular permission so all it's going to do is it's going to take the user's role it's going to get the role from this configuration right here

00:04:44  and it's going to check hey does that permission exist inside of it that's all it's going to do so I can replace all of this code right here and I can just say has permission and I can pass it in my user and I can pass it in what I want to do so in our case this is going to be for deleting some comments just like that now I'm getting a typing error specifically because my stuff doesn't line up with all the things that it expects you can see here it expects an ID of a string and a roll which is one of these roles admin moderator or user so I'm just going to get this type of Ro I'm going to come into here and I'm going to manually type this to say it's an ID which is a string or a roll which

00:05:18  is a roll make sure we get that being imported there we go give that a quick save make sure I actually export it from here first there we go and then we're going to import that from the correct file and there we go that should all work fine so now if I have the ability for example as an admin or as a moderator to delete this you can see it's going to work just fine and it gives me the permission to actually delete that particular thing now again the thing that makes this really nice is let's say in the future I decide you know what moderators can not actually delete these all I have to do is come into this one file remove the ability for moderators

00:05:50  to delete and now every other location in my code is going to work fine so if I for example had a UI that showed a button I had a server action that deleted something from my database and I had some other place in my code where something could be deleted for a comment I now do not need to change all those locations the old way I was doing things I would have to go to each place where I deleted a comment and update the particular permissions to say okay now remove this moderator check but now instead I just change it in one particular location now everywhere else that is checking for deleting comments the moderators no longer have permission to do that now you will immediately notice there's some limitations with

00:06:22  this system that we didn't have with the other system though and the main limitation is that it's very difficult for us to do any type of roles based on particular attributes of our objects that we're checking so for example originally I said that a user that was the same ID as the author ID was able to delete this so if I change this back to user and I make sure the ID of the user is the same as the author ID in my old system I was able to do this delete but right now in my new system I no longer have that ability so there's a few ways to get around this the main way if you have a rather simple use case where really all you're doing is checking can

00:06:54  they delete their own thing is you can add in a new permission called own delete or own whatever so for examp example here we can say own delete I'm sorry delete and we want to delete our own comment there we go so we can say we can delete anything as long as it's our own comments and same thing here we can do an update for our own comments there we go and we can do the same thing for our moderator up here to say for example that they can delete their own comments and so on we'll say that they can delete any comments and they can update only the ones that they own just like that so

00:07:25  now I can actually do a check here where I can say Okay can they delete the comments sure or do they have their permission to delete their own so user and this is going to be for deleting their own comments and here we need to just make sure that the check is here the user. ID is equal to the author ID let me get my parentheses all set up in place and we can take a look at this final code here and now we're first checking do they have permission to delete any comments or do they have permission to delete their own comment and is this particular comment their own comment now even with all of these

00:07:56  changes you can see that this system still has quite a lot of code that you need to write to check the permission especially when we're dealing with can they delete their own comments and if we were to add even more stipulations like okay you can only delete things that don't have particular statuses so imagine like a Blog article once it goes to a published status you can now no longer delete or update it so that's another check that you need to add in which requires you to add more permissions as you can see the system very quickly spirals out of control it works great for relatively simple systems but as soon as you get more complex it becomes very limited and that's where kind of the final permission system I want to talk about

00:08:28  comes in but before we into that it's a rather complicated system we first need to understand a lot of other things related to permissions so I want to go over a lot of those diagrams that I talked about and I also want to show you how you can implement this inside of clerk because right now we're just hardcoding all of our user objects and so on which is not ideal so I want to show you how to implement this with actual user objects so you can see this in a more real world scenario so the very first thing we need to do is just to get clerk set up inside of our application I've already done that but I'll show you what you need to do the very first thing you'll need to do is install the clerk next package cuz I'm in nextjs but if you're not in nextjs

00:08:59  you can do whatever you want install whatever clerk package you need but for nextjs we'll just install the clerk nextjs package then what you need to do is you need to wrap your entire application in this clerk provider right here which will make sure it provides all the different user authentication stuff you need you need to take all your environment variables you're going to need to copy them into your own EnV file here and then you're also going to want to set up a web hook so inside of our apis here we have a web hook a lot of this code is directly from the documentation but essentially all we're doing is we're taking in a web hook that every single time that we have the user

00:09:30  created event being fired pretty much all this code up here is just getting all the information from our web hook and ensuring it's coming from Clerk and then down here we're doing our actual code so we're just checking whenever a user is created we're making sure to update their role to have a role of user so let's just come in here and say their role is going to be user just like that now this is going to be setting information on their public metadata which is nice because now we can use this role anywhere whether we're on the client on the server it really doesn't matter we'll have access to the role directly on the user object now the final thing you need to add into your application to make sure that clerk is working is just your middleware file

00:10:01  this is directly copied from the clerk documentation as you can see here this is the clerk documentation going over everything you need to do and as you can see we install clerk get the EnV variables get our middleware wrap everything in the provider and that's literally it we're entirely done so rather straightforward once we have that done we can actually use clerk in our application so what I'm going to do is I'm going to add a really simple sign in and sign up button so I'm just going to paste this particular section in we're going to add in this signed out component as well as this sign in button there we go now this will give us a button at the top of our page that allow us to sign in or to sign out and as you

00:10:33  can see that button is showing up because we are currently signed out now if we click this signin button we can go through the process of signing in you can see I can continue with GitHub and say that I want to authorize clerk to be able to use my GitHub account and now we're actually signed in as you can see that button has disappeared and if I wanted I could get for example my user ID by just saying I want to await calling the off function from Clerk and I can just put that user ID anywhere inside of my page and now you can see my user ID is showing up what I want to do is I want to get that roll that's on my public metadata and the easiest way to do that is to add that metadata directly

00:11:05  to my token that is being issued to my user so where I'm getting this user ID there's this thing called session claims and this is all the information related to my JWT token now I want to add in my particular role so what I need to do is go back to the clerk page and inside of my configuration for my actual project I need to go down to sessions and here I can customize my session token by adding any information in I want so if I click on edit you can see here I've already done this where I added a brand new R property and this Ro property is going to get either my public metadata roll

00:11:36  which if you remember correctly reset inside of our vs code or it's going to default to a user rle if it has not been set yet so here it's just going to pull from my metadata or they're going to get the role of user by default now if we go back into our code we look at that web hook you remember I set my role to user right here but I could set it to whatever I want and we can go ahead and modify that later to show what that's going to look like but now if I have that session claims I can actually use that that inside of here session claims Dot and you can see I get roll now the reason roll is showing up for me in particular is because I added a particular type file right here that

00:12:08  adds that to my types for clerk this is just if you're using typescript you're going to want to add the particular type inside of here so you get autocomplete and so on so now I have my actual R and I can print that out like inside of an H1 or something there we go now at the very top of my page you can see my role shows up which is user now if I want to I can manually update that user's role for testing purposes so I can find that particular user go down to their public metadata click edit and let's change their role to admin here and this shouldn't be in an array this should just be a normal role just like that so we'll give it a quick save we'll come

00:12:40  back over here refresh our page and we should see that once we get that a refresh our role is now changed to admin so we're able to easily get the role inside of Clerk and now all we need to do is just plug that directly into our function here so we can essentially get rid of this entire user section right here we no longer need any of that and now we can just use our user down here so we can pass in whatever we want as our user I'll give it an object here so I'll just say const user equals I can get my user ID just like that so I can say my ID is my user ID and my RO is session claims. roll just like that and

00:13:12  technically this session claims is nullable so we'll just come in here and say if user ID is equal to null or if session claims is equal to null that essentially means that we're not signed in so what I'm going to do is I'm just going to going to take the code for this button I'm just going to move it up to Here There we go so I'm just going to return my signin button if I'm not signed in I can get rid of all that content down there and now my user is going to have a guaranteed ID and a guaranteed Ro inside of it so now we can see I have an admin roll I have my

00:13:43  comment and so on now we are getting an error in our code because you can see that button is not showing up that's just because my if check down here is incorrect which is again another reason why this system starts to fall apart as you get more complex that's why I'm going to show you a more fullprof permission system in just a bit but here we have our check if we have permission to do this or if we have permission to do this particular thing so I just need to make sure that I essentially wrap this entire top section inside a parentheses just like that then if we just add one more parenthesis right there delete the parenthesis down there give that a quick save and we refresh we see that should work just fine now so if

00:14:15  we're an admin user we again have the ability to delete this if I were to come over here and change my user back to a user a non-admin user give that a quick save and we'll make sure that the user ID is obviously different than this author ID they should no longer have the ability to delete and as you can see that delete button has gone away so we fully synced up our authentication system with clerk into this particular authentication system and going forward it's going to be very easy to continue to do that integration now the next thing I want to do is move over to all those diagrams I talked about so each one of these different diagrams is really more so built around doing this

00:14:47  inside of a database so as you can see the very simple idea that I had at the beginning was you have a user and that user has a role now this is generally not good enough so what we want to do is we want to move on from that to having multiple roles on a user user this is something we haven't even implemented yet but almost every authentication system you build should probably have multiple roles per user even if you never assign more than one role per user having the ability to do that makes this your system is more flexible and the extra code you need to write is very minimal so here we have a system that is built around having multiple roles for a particular user so we have a user and we

00:15:19  have a role and in this particular diagram every single blue thing that you see here is like a normal table so we have a user table and a roll table and all these green tables are like a join table in a database so one user can have multiple roles and one role can have multiple users so it's a many to many relationship now this will only take you so far though because a lot of times you have to deal with more things which are the permissions that we talked about so if you're doing this with a database style system you can see in your database you have a permissions table and every role can have multiple permissions and every permission can have multiple roles assigned to it now

00:15:51  we wrote our system inside of code which makes this particular section A little bit easier but again you can store it in a database in code however you want and this is pretty much where our permission system is currently at which works great for a lot of use cases but as you saw it is quite limited now if we move on to the next level of permission system you can see the only thing we added in is an organization pretty much if you're building any team based application think like slack or maybe you're building like a multi- tenant application again something like slack any application where users can be signed into multiple different organizations you're going to need to have this organization table and adding

00:16:23  this in is actually not too terribly complicated on the data side of things because all you do is you add in the organiz ation to the role so a user can have multiple roles and each one of those roles is associated with a particular organization so for example if you're an organization a and in organization B you may have like an admin role in one organization while you have a user role in a different organization and you can use one account to sign in and you're able to access all those different organizations by switching which organization you're signed into currently this is a really foolproof system for that type of organizations now it's a lot more

00:16:54  complicated than this diagram makes it look and clerk actually makes organization handling incred easy I'll show you how that works in just a bit the next level of permissions gets drastically more complicated as you can see this is the final version on this diagram that I'm going to show you everything in the top section is entirely exactly the same but what happens if you want to have something like a Google drive system because on Google Drive you can share documents with people you can share folders with people you can share things with other people so essentially you have a role for your entire organization like I am a user or I am an admin or maybe I have

00:17:26  multiple roles like I'm a sales rep and and I'm a tech lead I have all these different roles for my organization but I also have roles for individual resources in that organization as well for example if someone shares a file with me in Google Drive I may have the editor role on that file I have a viewer role on a different file and maybe I have an owner role on another entirely separate file so this system is incredibly complicated to do all those different connections the best way to model it is something like this where if you have just one particular thing

00:17:57  you're sharing for example let's say you have a Blog blog site and the only thing in your entire site that can be shared to multiple users is a Blog well then you can kind of hardcode this where you have another join table here that joins together all your users the blogs that they have access to as well as the roles so this R system right here is almost identical to this organization system up here but instead this is giving us particular roles to access individual resources instead of roles inside of an entire organization same thing here we're connecting all of our rules to our permissions and we use the exact same permissions between them that is all

00:18:29  right it's going to work just fine but now you can see here I'm able to give users particular permissions to individual resources inside of my system now this starts to fall apart though when you have multiple different things that you need to share for example what happens if you have blogs and you have files and you have images and all these other things you need to share well you could just copy this paste it down copy it paste it down again copy it paste it down and do this for every different type of resource you have but as you can see this becomes a mess rather quickly so usually what ends up happening is you make this essentially a generic table

00:19:01  and all you do is you make it so that inside this user R section it'll say something along the lines of what type of things so it's like type equals blog type equals file type equals whatever this is a rather complicated rule-based system and I'm going to show you how we can implement this in an even easier way instead of having to use this full on table system to do everything and that is by using something called attribute based access control a a and the whole idea behind attribute access control is that we're going to have four different parts of every single check that we make

00:19:32  we're going to have very first the subject this is almost always going to be the user object this is the thing trying to do whatever permission we're asking of it so we have a particular subject that says I want to do something we then have the action which is the thing they want to do like delete update read view whatever it is then we finally have the resource they want to do this on so this is going to be like I want to read all of the comments I want to read these particular comments I want to delete this one individual comment that's exactly what the resource is it is what is the thing you are acting upon

00:20:03  and then finally the fourth section is going to be any other additional information what organization are they a part of what environment are they are they in like a particular location are they on a phone all these different attributes that you can use to determine how you want this particular thing to come out so as you can see this looks very similar to our role-based access control but the big difference is that every single one of these sections has a bunch of attributes on it for example our subject our user has a user ID they have a particular Your Role maybe they have like a created ad date all these other things our resource has other things on it maybe it has an author ID

00:20:34  that we want to check it has like a publish date that we want to check it has a bunch of other things like is this a draft is it not a draft all these things that we can check inside of our permission to determine if we want to be able to do this particular action this is the system that we're going to be building because this is by far the most flexible system and this is the system that a lot of permission companies are going to charge you thousands of dollars to use I'm going to show you how to build it entirely for free so let's go back into our code and before we jump into actually handling this permission systems I first want to talk about some of the simpler ones which is how we handle organizations and how we handle multiple roles instead of just users

00:21:06  having one individual role now when it comes to handling organizations clerk has all of that built in which is incredibly nice you can even see they have this entire organizations tab right here what I can do is in the configure section I can set up all my different organization settings in particular my roles and my permissions for example I can have an admin role a moderator role a user role and any other roles that I want and I can also specify all the different permissions so we're dealing with comments here so I have a delete comments permission a read comments and update comments and a view comments permission and I can add all the other permission related stuff that I want to

00:21:37  have inside of here and also a really nice thing about clerk is they add in a bunch of their own permissions by default and these are permissions specifically related to how organizations are handled can users create organizations can they add users can they invite users can they delete users can they update users all the stuff related to actually managing your organization is built directly into here which is really nice so you don't have to worry about all of that stuff because it's honestly a lot more complicated than you think especially when you start dealing with inviting users users signing into to multiple different organizations at the same time and swapping between them all of that hands handled automatically for you by Clerk

00:22:09  and it just works out of the box all you have to do is just make sure that you enable organizations right here there's just a check box and you just turn it on and boom now you have organizations inside your application now if we want to deal with multiple roles this is also incredibly easy for us to do what we can do is we can come into our particular user this is going to be going back from non- organization way of doing things and I can just change this from from Roll to rolls and then I can change this to an array and there we go that's going to work just fine now also I would need to modify my code to support that so here this would say rolles and it's going to be a roll array and also inside

00:22:41  of here I would want to change this to roll and make this an array where by default the only role this user has is the user role then I would need to modify my code even further here this would say all my different roles and here where we check our has permission this is again going to need to change because this is going to take in an array of different roles so we just want to Loop through those so we can say return user. rolls make sure I spell that properly it's going to be rolls there we go do sum and for each one of my

00:23:15  roles I just want to return Calling this particular code right there and we're going to just pass in the roll make sure I wrap all this in the correct parentheses there we go and I need one more parentheses right there give that a quick save that's all working just fine now the final step is in my page here I just want to make sure that my user has a rolles property instead of a roll property give that a save and then we'll just want to make sure that this is also updated to rules and then we also need to configure our session here to make sure we pass along

00:23:46  a rolls and rolls just like that just because we renamed everything to rolls from Roll if you set this up originally the first time though you don't have to go through all that renaming now with all that done we should just hopefully be able to refresh our page and as you can see we get our roles at the very very top there and if we gave our user multiple rules we would see those multiple rules at the top there so let's go ahead and do that we'll go over to our particular user we'll edit this and we'll add in a second roll of admin give that a save and now if we come back over here give it a second and refresh a little bit more there you go now we can see both of our rules are

00:24:17  popping up right there now here is where we're going to go ahead and actually implement the incredibly complicated off system I talked about at the beginning of the video let's just go ahead and we're going to paste in the entire file for this and I'll go over all the code inside here cuz it's rather complex so the very first thing that we have is a bunch of different types this is to emulate all the different types inside of our data so we have a to-do we have a comment we have a user and we have a role and if we look at those types you can see a comment has an ID a body an author ID and a cread ad and here for our completed we have a completed field user ID title ID and we even have an array of all the different users we have

00:24:49  invited to access this particular to-do so this particular set of data is going to allow us to do a lot of things first we can check hey is this the author of a comment is this the person that created it to do we can check have they been invited to actually access this particular piece of data we can check is this to-do completed all these things we can use inside of our system also for our role you can see we have admin moderator user just like before but for our user I added in an extra field for blocked by so we can actually block particular users to again do all of these different complicated authentication and permission based things we can do permissions based on

00:25:20  are they invited are they blocked are things completed are they the author of this particular thing all of this is handled by the system incredibly easily so back to the off section at the top here I just have some rather complicated typescript the only thing that this typescript right here is doing is making it so that down here when we Define all of the different roles that we have we get full type safety so for example if I delete some of this stuff and I come into here you can see I get type safety for my comments inside of here I can get create update or view when I go to Define this create update or view I can either pass it a Boolean such as true or false or I can pass it a function and

00:25:51  this function also has full type safety for example if I come into here and I access my user I get all the user type safety if I access my comment I get all the comment type safety so that's all that this particular set of typescript at the top is doing let me just bring this code back to how it was before so don't even really worry about this it's just some complicated typescript to do all that it's probably not even written that well cuz I'm really not that great at typescript the next thing we have is this type right here called permissions and this is where you define all the different permissions inside your application so for example the very first permission we have is for comments

00:26:22  and the way I broke this out is the key here is the resource so inside that four step system I mentioned the resource so here's our resource our comments then I specify what the type of the comment is this is again only for typescript so typescript can give me nice autocomplete so I said this is a type of comment and in this to-do you can even see like let's say that I only want to have the ID portion I could just say author ID and now that's the only thing I'll have access to inside these functions so whenever I come down here to a comment you can see I have only access to the author ID so I can limit it however I want in my case I just left it as the

00:26:54  full comment and then I can specify a list of all the different actions so for example this can only be used with view create and update I don't even have the option to delete comments because that's not something my app can do in this particular use case same thing here we have our to-do and this one lets us view create update and delete so we can really fine- tune exactly what every single one of our different permissions can do then all you have to do is Define your permissions so for example comments on the admin we have true for everything same with to-dos we have true for everything for our moderator they can do everything with comments but with the to-dos for example they can view create and update any to-do they want but they

00:27:25  can only delete a to-do that's completed now this ability right here to do something based on the actual attributes of the object we're doing it on is something that's only possible in this attribute based access control system and our old role-based permission based system we had no way to do things based on the attributes of the object it required us to do these really big checks right here but now all that information is defined inside of my permission system so all my checks are going to go back to incredibly simple checks and my system for doing my permissions is all handled in this file same thing here when I get to users it's much more complicated because now I can

00:27:56  check for lots of different things for example a user can create any comment that they want but they can only view comments that are not from people that have blocked them so if one user blocked another one they no longer can see those comments they also can update any comment as long as they're the author if we look at the to-do section you can see again they can view any to-do as long as it was not blocked by someone else so if the user did not block them they can view it they can update any to-do where they were the author of it or any to-do that they've been invited to by another user and then finally they can delete any to-do that they have the particular IDE of or if they've been invited by the

00:28:27  other user they can delete it and they can only delete to-dos that have the completed property set to true so I'm just doing a bunch of things in here to show you all the flexibility that this has obviously you can do more or less flexibility it's entirely up to you but you can pretty much run any JavaScript code you want on your user your comment and you can pass in any other information you want inside of here as well I just have it relatively straightforward but you can see it's incredibly flexible with what you can do then our has permission function right here has changed slightly because now we need to pass it along our user just like before I broke our resource and our

00:28:59  action into two separate sections so now we can pass along for example something that looks like this it'll say has permission we pass it along our user we're going to pass it along our resource and we're going to pass it along the action next so it's going to be broken into two separate parameters and then finally if you want you can actually pass it some data and this particular data is going to be a comment object so I can pass along my own comment object as well so if I don't pass anything along that's checking do I have the ability to update every single comment in the database if I pass along a particular object that's saying do I have the ability to update this one

00:29:30  particular object so it's really flexible in how this system is going to work should I show you a demo of exactly how this happens I'm going to go back into my code over here I'm just going to get rid of everything that's in here paste down a bunch of new code and I'm going to show you exactly what this code looks like I also need to make sure up here that I changed one of my imports that'll import from the correct file make sure everything inside of here is saved and now if we go back to this particular page you can see at the very top I have a list of different to-dos and I'll make this a little bit wider so you can see exactly what's going on Zoom it out just a little bit there we go so that should be pretty easy for you to

00:30:01  see so I have a list of a bunch of different to-dos and I over here I have them on the right hand side so the very first to-do is got an ID of one it's by the user with the ID of one it's not completed and there's nobody invited the ID 2 here it's also by user number one so these first to-dos on the very first row are both by user number one and they are either completed or not completed so there's an X it means it's not completed if there's a check mark it means it is completed then finally the next two to-dos are by user number two and this final to-do this very last one has been invited to by user 1 and three so user 1

00:30:32  and three are invited to that particular to-do then here I'm defining my user I'm card coding it for now we'll Implement clerk in just a little bit but this is easier for me to play around with what the data is for demonstration purposes and finally I have a bunch of different button checks so I have this General button check and if we scroll down to that function you can see all it's doing is calling has permission passing it my user passing it my resource and passing it the action and if we can perform that action it's going to give me a blue button while if I cannot per per that action it's going to give me a red button so at the very top here I'm checking can I do a view create update

00:31:03  and delete on all of the toos in my database this is just a general can I do this with to-dos as you can see the user with the ID of three has a role of user they are unable to view all of them they can create any that they want but they unable to update all of them and they're unable to delete all of them now if I were in particular changing this role to admin and I give this a save you can now see the admin everything changes to blue because the admin has permission to do pretty much everything in our application and the next thing I'm doing is I'm looping through each to-do and inside of each to-do I'm adding three separate buttons that check to see if

00:31:35  they have permission to view update and delete that particular to-do and if we look at the code for the has permission you can see it's passing along my user it's passing along the thing I want to check which in my case is to-dos it's passing along the action I want to check is it view delete update and so on and finally I'm passing the individual to-do along so this is going to make sure I do all of those additional checks so if I go up into here you can see I pass along my to-do it's going to call this particular function with all of the code inside of it so now let's come back into here and we can really play around with how flexible this permission system is

00:32:06  because if we come in here and we're going to say we are user with ID of one and we give this a quick save you can see the user with an ID of one can view all of these different things they can view all the to-dos which is fine because they're not blocked by anybody they can update the to-dos that they have created themselves they can delete the to-dos that they've created themselves that are also marked as complete and you can see here they've been invited to this particular to-do down here so they also have the ability to update and delete this to-do but this to-do by user 2 they did not have permission to do anything on it so you can see update and delete are blocked

00:32:37  out now let's come in here with user 3 instead you can see user 3 has particular access to this one because they've been invited let's say that they've actually been blocked by user 2 if we give this a quick save you can now see they are prevented from viewing anything that user 2 has created because they are blocked by that user same thing here if we go with user one you can see they prevented from actually viewing any of the inform information here because they've been blocked by that particular user now if our user has multiple roles for example a moderator we don't want a moderator to be able to be blocked from someone so if the moderator is the actual role here you can see they can

00:33:08  still view things even if they've been blocked because they're a moderator they should be able to get around that blocking that's why we have moderators in the first place and you can see this particular person has multiple roles we're checking how multiple roles work now implementing this with clerk is again relatively straightforward we just want to make sure we get our session claims again so we can say const session claims that's going to be equal to calling the off function this is an async function so make sure we put async right there we await this I'm going to get the

00:33:40  user ID as well there we go and I'll just say here if our session claims is equal to null or our user ID is equal to null then I'm just going to return the button for signing in so I'll just copy over that button real quick there we go now we have our signin button and then finally what we can do is we can actually get our user so we can say user is equal to the ID is our user ID and our roles is your session

00:34:12  claims. rolles there we go and then we can say that we are blocked by users what did I call it up here blocked by there we go and we'll just say they aren't blocked by anyone you can you could get that from your database you could get it from session claims you can get it from pretty much anywhere you want but now everything should work just fine with our particular user object which just make sure that we're passing our user everywhere that it needs to be so what I'm going to do is just take my user I'm going to pass it along as a prop just like that to every single one of these

00:34:44  because we need to have access to that and same thing here I'll pass it into my to-do so we can say this function for to-do is going to take in all of my to-do props as well as a user and for now we just type this as any just so I can get around all the typing stuff so this is going to be any and to do which is it to do and to do that particular typing I you just come in here just like that that'll fix all those problems and then same thing here I'll pass in a user and I'll just

00:35:16  give it the type of any just so we can get around all the types script stuff because that's not actually important now the last thing I need to do is pass along my user here there we go paste that down and inside of here we're going to be passing along a user again just with a type of any for now and I believe I made an error up here this should not have a type in line that should fix our problem and there we go you can see that this user has the role of user and admin so they have permission to access everything because they are an admin but if we want to modify our user to no longer make them an admin let's remove

00:35:48  that admin permission now and give this a quick save come back over here give it a second and we'll refresh and now you can see that we are a user the user ID does not match any of these user IDs so we can't update or delete any of them we can view them because we're not blocked by any of these people I could obviously modify this and say that we are blocked by user one and now I can no longer view users one stuff while I can still use view users 2 stuff now I know I went through the code in this video rather quickly so if you want to Deep dive into any of these permission systems I'm going to have a link to a GitHub repository that includes all these different permission systems so you can

00:36:19  go and tweak them read them and see exactly what they're about also if you liked Clerk and you want to check out a really good authentication system that just makes authentic brain dead easy where you never have to think about it again highly recommend you check out clerk I love using it with my various projects I'll leave a link in the description down below with that said thank you very much for watching and have a good day