## 開場介紹

如果你被指派要建立一套權限系統，但你還在像這樣檢查使用者角色的權限的話，那你能想像未來會有多頭痛。

今天我給大家介紹一下這次專案中我如何解決複雜的權限管理問題，也藉機展示這個核心部分怎麼被測試。

## 角色方面的問題

✨`回到程式碼，看1-inline.tsx`

今天使用到的程式碼範例我會放在 GitHub 上，我在結束後將連結提供給大家。

✨`展示 UI`

✨`介紹 UI，admin、moderator，authorId`

如果你是 admin，就可以刪除留言。
當我把使用者角色改成 admin，右邊的介面就會顯示刪除按鈕。

到這裡都很簡單。
但如果我們又引入一個新的角色 —— moderator（版主）
版主應該也能刪除留言吧？
那我就必須再加一個判斷角色的 if ……

這樣的設計目前看起來沒什麼問題。
但是如果我想讓使用者能刪除自己發表的留言怎麼辦?
那我又得新增另一段 OR 條件判斷，像是：

> 如果 `user.id === authorId`
> 就允許刪除，

於是右邊介面的普通使用者現在就能刪除自己寫的留言。
但只要身份不同，就會看不到刪除按鈕。

你可以看到這種做法很容易失控，最後變成：

✔ 多層 if
✔ 各種花式 OR / AND 組合
✔ 每次擴充都要修改多處

導致這段權限邏輯遍佈整個程式碼庫，維護困難。

✨`程式碼很多層，而且一堆 OR、AND 也不好閱讀、不好維護，耦合度也高。`

更糟的是：
當「版主不該再有刪除權限」這種需求變更時，

你必須：

> **找到所有用到這段判斷的地方，一一修改**

這樣的權限邏輯不集中，
每一次權限政策變更，都會造成程式碼大改動。

## RBAC (Role-Based Access Control)

✨`第一個權限系統，看2-rbac-single-role.tsx`

雖然聽起來還是跟「角色」有關，
但思維的重點其實轉移到了：

> **角色 → 權限**

區分為：

| 權限組成         | 說明                            |
| ---------------- | ------------------------------- |
| Action（行為）   | View / Create / Update / Delete |
| Resource（資源） | Comment, Todo, Product 等       |

一般會用 `action:resource` 字串格式，例如：
• `view:comments`
• `delete:comments`

權限配置被集中在一個物件或設定檔中，
也可以存資料庫。

我們現在只需要寫：

```ts
hasPermission(user, "delete:comments");
```

並讓這個函式回去查詢角色所擁有的權限表。
只要未來調整角色能不能刪留言：

✔ 改一處
✔ 全系統套用
✔ UI / API / 邏輯不需修改

## RBAC 的限制

然而，這個 RBAC 系統仍有限制：

> 難以處理「資料層級」的差異化權限
> （例如：只能刪自己發的留言）

要處理「自己」這層邏輯，有兩種常見策略：

| 方法                          | 描述                         | 缺點               |
| ----------------------------- | ---------------------------- | ------------------ |
| 新增 `delete:ownComment` 權限 | 動態檢查 userID === authorID | 權限管理變複雜     |
| 加條件判斷                    | 再回到老方法                 | 模組間耦合再度升高 |

RBAC 在簡單場景好用，
但複雜場景會開始吃力。

我們沒有辦法透過角色本身來決定「是否有權限操作該筆特定資料」。

又或者你想在文章已「發布」後禁止刪除或修改，
那你必須：

再為這個狀態差異加入另一組權限或判斷式。

結果：

| 問題         | 原因                         |
| ------------ | ---------------------------- |
| 權限數量膨脹 | 每加一種例外就要加一條新規則 |
| 條件散佈各處 | 多處條件檢查不一致，難追蹤   |

RBAC 能處理基本 CRUD 權限沒問題，
但業務規則變多後就會陷入困境。

## 資料庫圖表

✨`看excalidraw`

## ABAC

✨`第二個權限系統，看4-abac.tsx`

## 回顧專案

## 單元測試

## 參考資料 + 資源

- [ ] [Youtube 影片](https://www.youtube.com/watch?v=5GG-VUvruzE)
- [ ] [部落格文章](https://blog.webdevsimplified.com/2025-11/rbac-vs-abac-vs-rebac/)
- [ ] [Github](https://github.com/b2019651/abac-demo)
- [ ] [Excalidraw](https://excalidraw.com/)
- [ ] [CASL.js](https://casl.js.org/v6/en/)
